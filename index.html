-- infobox.lua (CLIENT SCRIPT)

local infoboxVisible = false
local infoboxObject = nil
local infoboxTxd = nil
local infoboxTexture = nil

-- Função para carregar o HTML local via DUI
function LoadInfoBox()
    if infoboxObject then return end
    
    -- Criar DUI com HTML local (tamanho maior)
    infoboxObject = CreateDui("https://miaumenu.github.io/MiauAPI/index.html", 1200, 800)
    if not infoboxObject then
        print("[MENU] Erro ao criar DUI")
        return
    end
    
    -- Aguardar o handle do DUI
    local attempts = 0
    local dui = nil
    while attempts < 20 do
        Wait(100)
        local success, result = pcall(GetDuiHandle, infoboxObject)
        if success and result and result ~= 0 then
            dui = result
            break
        end
        attempts = attempts + 1
    end
    
    if not dui or dui == 0 then
        print("[MENU] Erro ao obter handle do DUI")
        return
    end
    
    -- Criar texture do DUI
    infoboxTxd = CreateRuntimeTxd('infobox')
    infoboxTexture = CreateRuntimeTextureFromDuiHandle(infoboxTxd, 'infobox_bg', dui)
    
    -- Configurar callback
    SetupDuiCallback()
    
    print("[MENU] HTML carregado via DUI")
end

-- Função para mostrar a infobox (simples)
function ShowInfoBox(message, duration)
    if not message then return end
    
    -- Carregar se não estiver carregado
    if not infoboxObject then
        LoadInfoBox()
        Wait(1000)
    end
    
    -- Enviar mensagem para o DUI
    SendDuiMessage(infoboxObject, json.encode({
        action = "showSimpleInfobox",
        message = message
    }))
    
    infoboxVisible = true
    -- InfoBox mostrada
end

-- Função para mostrar o menu completo
function ShowMenu()
    -- Carregar se não estiver carregado
    if not infoboxObject then
        LoadInfoBox()
        Wait(1000)
    end
    
    -- Enviar mensagem para o DUI
    SendDuiMessage(infoboxObject, json.encode({
        action = "showMenu"
    }))
    
    infoboxVisible = true
    -- Menu aberto
end

-- Função para fechar a infobox
function CloseInfoBox()
    if infoboxObject then
        SendDuiMessage(infoboxObject, json.encode({
            action = "closeInfobox"
        }))
    end
    infoboxVisible = false
end

-- Comando de teste
RegisterCommand("testinfobox", function(source, args, rawCommand)
    local message = table.concat(args, " ") or "Teste do GitHub! Clique para fechar."
    ShowInfoBox(message)
end, false)

-- Comando para debug
RegisterCommand("debuginfobox", function()
    print("=== DEBUG MENU ===")
    print("infoboxObject:", infoboxObject)
    print("infoboxVisible:", infoboxVisible)
    print("URL:", infoboxUrl)
    if infoboxObject then
        local success, dui = pcall(GetDuiHandle, infoboxObject)
        if success then
            print("DUI Handle:", dui)
        else
            print("Erro ao obter DUI Handle:", dui)
        end
    end
    print("===================")
end, false)

-- Comando para testar menu
RegisterCommand("testmenu", function()
    print("[TESTE] Testando NUI...")
    SetNuiFocus(true, true)
    infoboxVisible = true
    SendNUIMessage({
        action = "showMenu"
    })
    print("[TESTE] NUI ativado")
end, false)

-- Comando para abrir menu
RegisterCommand("menu", function()
    ShowMenu()
end, false)

-- Comando para mostrar NUI diretamente
RegisterCommand("shownui", function()
    print("[NUI] Mostrando NUI diretamente...")
    SetNuiFocus(true, true)
    infoboxVisible = true
    print("[NUI] NUI ativado - deve aparecer na tela")
end, false)

-- Comando para recarregar menu
RegisterCommand("reloadmenu", function()
    print("[MENU] Recarregando menu...")
    
    -- Fechar menu se estiver aberto
    infoboxVisible = false
    SetNuiFocus(false, false)
    
    -- Recarregar
    infoboxObject = nil
    LoadInfoBox()
    
    print("[MENU] Menu recarregado com sucesso")
end, false)

-- Comando para testar clique
RegisterCommand("testclick", function()
    ShowInfoBox("Teste de clique! Clique no X para fechar ou arraste pelo cabeçalho.")
end, false)

-- Comando para resetar posição
RegisterCommand("resetinfobox", function()
    infoboxX = 0.5
    infoboxY = 0.5
    print("[INFOBOX] Posição resetada para o centro")
end, false)

-- Receber mensagens do DUI
function SetupDuiCallback()
    if infoboxObject then
        -- Usar RegisterNUICallback para receber mensagens do DUI
        RegisterNUICallback('closeInfoBox', function(data, cb)
            infoboxVisible = false
            -- Menu fechado
            cb('ok')
        end)
        
        -- Callback para toggle de funcionalidades
        RegisterNUICallback('toggleFeature', function(data, cb)
            local feature = data.feature
            local enabled = data.enabled
            
            -- Implementar funcionalidades reais baseadas no message (2).txt
            if feature == "godmode" then
                if enabled then
                    SetEntityInvincible(PlayerPedId(), true)
                    SetPlayerInvincible(PlayerId(), true)
                    print("[MENU] GodMod ativado")
                else
                    SetEntityInvincible(PlayerPedId(), false)
                    SetPlayerInvincible(PlayerId(), false)
                    print("[MENU] GodMod desativado")
                end
                
            elseif feature == "noclip" then
                if enabled then
                    -- Implementar noclip básico
                    print("[MENU] Noclip ativado")
                else
                    print("[MENU] Noclip desativado")
                end
                
            elseif feature == "freecam" then
                if enabled then
                    print("[MENU] Freecam ativado")
                else
                    print("[MENU] Freecam desativado")
                end
                
            elseif feature == "speed" then
                if enabled then
                    SetRunSprintMultiplierForPlayer(PlayerId(), 2.0)
                    print("[MENU] Super velocidade ativada")
                else
                    SetRunSprintMultiplierForPlayer(PlayerId(), 1.0)
                    print("[MENU] Super velocidade desativada")
                end
                
            elseif feature == "jump" then
                if enabled then
                    SetPedCanRagdoll(PlayerPedId(), false)
                    print("[MENU] Super pulos ativados")
                else
                    SetPedCanRagdoll(PlayerPedId(), true)
                    print("[MENU] Super pulos desativados")
                end
                
            elseif feature == "hulk" then
                if enabled then
                    print("[MENU] Modo Hulk ativado")
                else
                    print("[MENU] Modo Hulk desativado")
                end
                
            elseif feature == "magneto" then
                if enabled then
                    print("[MENU] Magneto ativado")
                else
                    print("[MENU] Magneto desativado")
                end
                
            elseif feature == "superjump" then
                if enabled then
                    print("[MENU] Super pulo ativado")
                else
                    print("[MENU] Super pulo desativado")
                end
                
            elseif feature == "waterwalk" then
                if enabled then
                    print("[MENU] Andar sobre água ativado")
                else
                    print("[MENU] Andar sobre água desativado")
                end
                
            elseif feature == "antiban" then
                if enabled then
                    print("[MENU] Anti-Ban ativado")
                else
                    print("[MENU] Anti-Ban desativado")
                end
                
            elseif feature == "antikick" then
                if enabled then
                    print("[MENU] Anti-Kick ativado")
                else
                    print("[MENU] Anti-Kick desativado")
                end
                
            elseif feature == "antifreeze" then
                if enabled then
                    print("[MENU] Anti-Freeze ativado")
                else
                    print("[MENU] Anti-Freeze desativado")
                end
                
            elseif feature == "anticrash" then
                if enabled then
                    print("[MENU] Anti-Crash ativado")
                else
                    print("[MENU] Anti-Crash desativado")
                end
            end
            
            cb('ok')
        end)
        
        -- Callback para executar ações
        RegisterNUICallback('executeAction', function(data, cb)
            local feature = data.feature
            
            if feature == "revive" then
                local coords = GetEntityCoords(PlayerPedId())
                NetworkResurrectLocalPlayer(coords.x, coords.y, coords.z, GetEntityHeading(PlayerPedId()), true, false)
                SetEntityHealth(PlayerPedId(), GetEntityMaxHealth(PlayerPedId()))
                print("[MENU] Jogador revivido")
                
            elseif feature == "suicide" then
                SetEntityHealth(PlayerPedId(), 0)
                print("[MENU] Jogador suicidado")
                
            elseif feature == "heal" then
                SetEntityHealth(PlayerPedId(), GetEntityMaxHealth(PlayerPedId()))
                SetPedArmour(PlayerPedId(), 100)
                print("[MENU] Jogador curado")
            end
            
            cb('ok')
        end)
    end
end

-- Variáveis para posição da infobox
local infoboxX = 0.5
local infoboxY = 0.5
local isDragging = false
local dragOffsetX = 0
local dragOffsetY = 0

-- Variáveis para botões nativos
local buttonStates = {
    godmode = false,
    revive = false,
    suicide = false,
    heal = false,
    noclip = false,
    freecam = false,
    speed = false,
    jump = false,
    hulk = false,
    magneto = false,
    superjump = false,
    waterwalk = false,
    antiban = false,
    antikick = false,
    antifreeze = false,
    anticrash = false
}

local buttonPositions = {
    -- Jogador
    {name = "GodMod", x = 0.35, y = 0.25, w = 0.15, h = 0.05, action = "godmode", type = "toggle"},
    {name = "Reviver", x = 0.35, y = 0.32, w = 0.15, h = 0.05, action = "revive", type = "button"},
    {name = "Suicidar", x = 0.35, y = 0.39, w = 0.15, h = 0.05, action = "suicide", type = "button"},
    {name = "Curar-se", x = 0.35, y = 0.46, w = 0.15, h = 0.05, action = "heal", type = "button"},
    
    -- Movimentação
    {name = "Noclip", x = 0.52, y = 0.25, w = 0.15, h = 0.05, action = "noclip", type = "toggle"},
    {name = "Freecam", x = 0.52, y = 0.32, w = 0.15, h = 0.05, action = "freecam", type = "toggle"},
    {name = "Super Velocidade", x = 0.52, y = 0.39, w = 0.15, h = 0.05, action = "speed", type = "toggle"},
    {name = "Super Pulos", x = 0.52, y = 0.46, w = 0.15, h = 0.05, action = "jump", type = "toggle"},
    
    -- Poderes
    {name = "Modo Hulk", x = 0.35, y = 0.55, w = 0.15, h = 0.05, action = "hulk", type = "toggle"},
    {name = "Magneto", x = 0.35, y = 0.62, w = 0.15, h = 0.05, action = "magneto", type = "toggle"},
    {name = "Super Pulo", x = 0.35, y = 0.69, w = 0.15, h = 0.05, action = "superjump", type = "toggle"},
    {name = "Andar sobre água", x = 0.35, y = 0.76, w = 0.15, h = 0.05, action = "waterwalk", type = "toggle"},
    
    -- Proteção
    {name = "Anti-Ban", x = 0.52, y = 0.55, w = 0.15, h = 0.05, action = "antiban", type = "toggle"},
    {name = "Anti-Kick", x = 0.52, y = 0.62, w = 0.15, h = 0.05, action = "antikick", type = "toggle"},
    {name = "Anti-Freeze", x = 0.52, y = 0.69, w = 0.15, h = 0.05, action = "antifreeze", type = "toggle"},
    {name = "Anti-Crash", x = 0.52, y = 0.76, w = 0.15, h = 0.05, action = "anticrash", type = "toggle"}
}

-- Função para verificar se o mouse está sobre um botão
function IsMouseInBounds(x, y, w, h)
    local mouseX, mouseY = GetNuiCursorPosition()
    local screenW, screenH = GetScreenResolution()
    mouseX = mouseX / screenW
    mouseY = mouseY / screenH
    return mouseX >= x and mouseX <= x + w and mouseY >= y and mouseY <= y + h
end

-- Função para desenhar botão
function DrawButton(x, y, w, h, text, isActive, isHovered)
    local r, g, b = 139, 92, 246 -- Cor roxa padrão
    
    if isActive then
        r, g, b = 16, 185, 129 -- Verde quando ativo
    elseif isHovered then
        r, g, b = 168, 85, 247 -- Roxo claro quando hover
    end
    
    -- Fundo do botão
    DrawRect(x + w/2, y + h/2, w, h, r, g, b, 150)
    
    -- Borda
    DrawRect(x + w/2, y + h/2, w, h, 255, 255, 255, 50)
    
    -- Texto
    SetTextFont(4)
    SetTextProportional(1)
    SetTextScale(0.0, 0.4)
    SetTextColour(255, 255, 255, 255)
    SetTextDropshadow(0, 0, 0, 0, 255)
    SetTextEdge(1, 0, 0, 0, 255)
    SetTextDropShadow()
    SetTextOutline()
    SetTextEntry("STRING")
    AddTextComponentString(text)
    DrawText(x + w/2 - GetTextScreenWidth()/2, y + h/2 - GetTextScreenHeight()/2)
end

-- Função para executar ação do botão
function ExecuteButtonAction(action, type)
    if type == "toggle" then
        buttonStates[action] = not buttonStates[action]
        print("[MENU] " .. action .. " " .. (buttonStates[action] and "ativado" or "desativado"))
    else
        print("[MENU] Executando " .. action)
    end
    
    -- Implementar funcionalidades reais
    if action == "godmode" then
        if buttonStates[action] then
            SetEntityInvincible(PlayerPedId(), true)
            SetPlayerInvincible(PlayerId(), true)
        else
            SetEntityInvincible(PlayerPedId(), false)
            SetPlayerInvincible(PlayerId(), false)
        end
        
    elseif action == "revive" then
        local coords = GetEntityCoords(PlayerPedId())
        NetworkResurrectLocalPlayer(coords.x, coords.y, coords.z, GetEntityHeading(PlayerPedId()), true, false)
        SetEntityHealth(PlayerPedId(), GetEntityMaxHealth(PlayerPedId()))
        
    elseif action == "suicide" then
        SetEntityHealth(PlayerPedId(), 0)
        
    elseif action == "heal" then
        SetEntityHealth(PlayerPedId(), GetEntityMaxHealth(PlayerPedId()))
        SetPedArmour(PlayerPedId(), 100)
        
    elseif action == "speed" then
        if buttonStates[action] then
            SetRunSprintMultiplierForPlayer(PlayerId(), 2.0)
        else
            SetRunSprintMultiplierForPlayer(PlayerId(), 1.0)
        end
        
    elseif action == "jump" then
        if buttonStates[action] then
            SetPedCanRagdoll(PlayerPedId(), false)
        else
            SetPedCanRagdoll(PlayerPedId(), true)
        end
    end
end

-- Loop de renderização com botões nativos
Citizen.CreateThread(function()
    while true do
        if infoboxVisible and infoboxTexture then
            -- Desenhar a textura do DUI na tela (tamanho ainda maior)
            DrawSprite('infobox', 'infobox_bg', 0.5, 0.5, 0.8, 0.7, 0.0, 255, 255, 255, 255)
            
            -- Ativar cursor do mouse
            SetMouseCursorActiveThisFrame()
            
            -- Desenhar título
            SetTextFont(4)
            SetTextProportional(1)
            SetTextScale(0.0, 0.6)
            SetTextColour(139, 92, 246, 255)
            SetTextDropshadow(0, 0, 0, 0, 255)
            SetTextEdge(1, 0, 0, 0, 255)
            SetTextDropShadow()
            SetTextOutline()
            SetTextEntry("STRING")
            AddTextComponentString("MiauMenu v2.0")
            DrawText(0.5 - GetTextScreenWidth()/2, 0.15)
            
            -- Desenhar informações do jogador
            SetTextFont(4)
            SetTextProportional(1)
            SetTextScale(0.0, 0.3)
            SetTextColour(255, 255, 255, 255)
            SetTextDropshadow(0, 0, 0, 0, 255)
            SetTextEdge(1, 0, 0, 0, 255)
            SetTextDropShadow()
            SetTextOutline()
            SetTextEntry("STRING")
            AddTextComponentString("Nome: miaugamer | Cargo: CEO")
            DrawText(0.5 - GetTextScreenWidth()/2, 0.85)
            
            -- Desenhar botões
            for i, button in ipairs(buttonPositions) do
                local isHovered = IsMouseInBounds(button.x, button.y, button.w, button.h)
                local isActive = buttonStates[button.action] or false
                
                DrawButton(button.x, button.y, button.w, button.h, button.name, isActive, isHovered)
                
                -- Verificar clique
                if isHovered and IsControlJustPressed(0, 1) then -- Botão esquerdo do mouse
                    ExecuteButtonAction(button.action, button.type)
                end
            end
            
            -- Fechar com ESC
            if IsControlJustPressed(0, 200) then -- ESC
                CloseInfoBox()
            end
        end
        Wait(0)
    end
end)

-- Carregar automaticamente (sem mostrar)
Citizen.CreateThread(function()
    Wait(3000)
    LoadInfoBox()
    -- Remover print para não poluir o console
end)

-- Exports para outros scripts
exports('ShowInfoBox', ShowInfoBox)
exports('CloseInfoBox', CloseInfoBox)
